<!DOCTYPE html>
<html>
<head>
<title>珍爱网-首页</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap -->
<link href="/css/style.css" rel="stylesheet" media="screen">
<link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="/css/style.css" rel="stylesheet" media="screen">
<link href="/js/lightbox/css/lightbox.css" rel="stylesheet" />

</head>
<body style="background:#fff !important; overflow:hidden;">
<div style="overflow:hidden;">

	<a id="modal-695811" href="#modal-container-695811" role="button" class="btn btn-info" data-toggle="modal">上传照片</a>
	<div id="modal-container-695811" class="modal hide fade" role="dialog" aria-labelledby="myModalLabel2" aria-hidden="true">
		<div class="modal-header">
			 <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
			<h3 id="myModalLabel2">
				上传照片
			</h3>
			
		</div>
		<div class="modal-body">
				<div class="alert alert-info">
					<strong>警告!</strong> 请注意你的个人隐私安全.
				</div>
				<form class="form-horizontal" id="photo_form">
					<div class="control-group">
						<div class="controls">
							<input type="file" placeholder="选择图片" id="photo">
						</div>
					</div>
				</form>
		</div>
		<div class="modal-footer tc">
			<button class="btn btn-primary" data-loading-text="正在加载" id="upload_photo">上传</button>
		</div>
	</div> 
	
	<ul class="photos" id="photo_list">	</ul>
</div>
<input type="hidden" id="wedding_id" value="<%= id %>">
<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script src="/js/lightbox/js/lightbox-2.6.min.js"></script>
<script src="/bootstrap/js/bootstrap.min.js"></script>
<script src="https://cn.avoscloud.com/scripts/lib/av-0.2.7.min.js"></script>
<script type="text/javascript">
        AV.initialize("fe8r9l7ml0ib0ycsh03olv9qcxtay51v3jdtbg5u78m4s7vr", "r345znn0o1c3mfx11u49rn5mwqsty5h0xfb3pe3u3rumzbt2");
</script>
    <script type="text/javascript">
	var categoryId = '<%= id%>';
	
	function createTpl(str, cfg) {
		var _re = /(%([\w]+?)%)/g;
		
		return str.replace(_re, function() {
			var _val = cfg[arguments[2]]+'';
			if(typeof _val == 'undefined') {
				_val = '';
			}
			return _val;
		});
	}
	
	function initPhotoTpl(conf){
		var tpl = '<li id="%id%"><a href="%img%"  data-lightbox="demo" ><img class="img-polaroid" src="%img%?imageView/2/w/300" alt="" /></a></li>';
		var str = createTpl(tpl,conf);
		return str;
	}
	
	function uploadImage(fileController,callback){
		var fileUploadControl = fileController[0];
		if (fileUploadControl.files.length > 0){
			var file = fileUploadControl.files[0];
  			var name = "photo.jpg";

			var avFile = new AV.File(name,file);
			avFile.save().then(function(file){
				callback && callback(file);
			},function(error){});
			
		}else{
			alert('请选择要上传的图片。');
		}
	}
	
	//创建相册
	$('#upload_photo').on('click',function(){
		uploadImage($('#photo'),function(file){
			var fileId = file.id;
			var Photo = AV.Object.extend('Photo');
			var photo = new Photo();
			photo.set('categoryId',categoryId);
			photo.set('image',file);
			photo.save(null,{
				success:function(photo){
					$('.close').click();
					var id = photo.id;
					var img = photo.get('image').url();
					var node = initPhotoTpl({id:id,img:img});
					$(node).appendTo($('#photo_list'));
					$('#photo_form')[0].reset();
				},
				error:function(){
					
				},
			});
		});
		return false;
	});
	
	function init(){
		var Photo = AV.Object.extend('Photo');
		var queryPhoto = new AV.Query(Photo);
		queryPhoto.equalTo("categoryId", categoryId);
		
		queryPhoto.find({
		  success: function(results) {
			var _html = '';
			
			for (var i=0,len=results.length; i<len; i++){
				var obj = results[i];
				var id = obj.id;
				var img = obj.get('image').url();
				_html += initPhotoTpl({id:id,img:img});
			}
			$('#photo_list').html(_html);
		  },
		  error: function(error) {
			alert("Error: " + error.code + " " + error.message);
		  }
		});
		
	}
	
	init();
</script>
</body>
</html>